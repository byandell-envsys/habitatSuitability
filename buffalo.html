<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.33">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Buffalo Grasslands</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="buffalo_files/libs/clipboard/clipboard.min.js"></script>
<script src="buffalo_files/libs/quarto-html/quarto.js"></script>
<script src="buffalo_files/libs/quarto-html/popper.min.js"></script>
<script src="buffalo_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="buffalo_files/libs/quarto-html/anchor.min.js"></script>
<link href="buffalo_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="buffalo_files/libs/quarto-html/quarto-syntax-highlighting-07ba0ad10f5680c660e360ac31d2f3b6.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="buffalo_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="buffalo_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="buffalo_files/libs/bootstrap/bootstrap-fe6593aca1dacbc749dc3d2ba78c8639.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Buffalo Grasslands</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Currently using python 3.11.10 with the <a href="https://github.com/earthlab/earth-analytics-python-env"><code>earth-analytics-python</code> environment</a>. Using <a href="https://ipython.readthedocs.io/en/stable/config/extensions/storemagic.html">StoreMagic</a> to store and retrieve intermediate calculations. Code chunks are specific to this project (using name <code>buffalo</code>) but use generic functions from the <a href="https://github.com/byandell-envsys/landmapy">landmapy</a> module.</p>
<section id="buffalo-grasslands-habitat-suitability" class="level1">
<h1>Buffalo Grasslands Habitat Suitability</h1>
<p>This project examines habitat suitability for <a href="https://greg.app/big-bluestem-soil/">Blue Stem</a> in the <a href="https://www.fs.usda.gov/recarea/nebraska/recarea/?recid=30329">Buffalo Gap</a> and <a href="https://www.fs.usda.gov/recarea/nebraska/recarea/?recid=30328">Oglala</a> National Grasslands. These contiguous grasslands are located in <a href="https://americanindian.si.edu/nk360/plains-belonging-nation/oceti-sakowin">Oceti Sakowin Oyate</a>, also known as the Lakota Nation or Great Sioux Nation, and in the US states of South Dakota and Nebraska. For more information see <a href="https://sdtribalrelations.sd.gov/docs/OSEUs-18.pdf">Oceti Sakowin Essential Understandings &amp; Standards</a>.</p>
<p>Blue Stem, according to <a href="https://greg.app/">Greg</a>, “need well-drained, nutrient-rich soils. The best soil types for this grass are sandy loam or loamy soil, which provide the right balance of drainage and nutrients. Aim for an organic matter content of 5-10%. This range is crucial for optimal growth, as it enhances soil fertility and structure. The ideal pH range for Big Bluestem is between 6.0 and 7.0. This slightly acidic to neutral pH is essential for nutrient availability, ensuring your plants can absorb what they need to thrive.”</p>
<p><a href="https://www.gardeners.com/how-to/what-type-of-soil-do-you-have/9120.html#:~:text=Most%20common%20garden%20plants%20prefer,well%2Dadapted%20to%20clay%20soils.">Gardners.com</a> has a <a href="https://www.gardeners.com/globalassets/articles/gardening/2014content/9120-soil-texture-triangle-sample.png?$staticlink$">soil simplex figure</a>, which puts sandy loam and loamy sand at 50-85% sand.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://www.gardeners.com/globalassets/articles/gardening/2014content/9120-soil-texture-triangle-sample.png?$staticlink$" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>I could not find information on slope or aspect but I have seen blue stem on flat areas and slopes.</p>
<section id="project-specs" class="level3">
<h3 class="anchored" data-anchor-id="project-specs">Project Specs</h3>
<p>The project compares</p>
<ul>
<li>two grassland habitats: Buffalo Gap and Oglala National Grasslands</li>
<li>one species: Blue Stem</li>
<li>one soil measurement: percent sand, and maybe pH</li>
<li>two climate scenarios: (e.g.&nbsp;different time periods, different emission scenarios)
<ul>
<li><a href="https://coastadapt.com.au/infographics/what-are-rcps">Relative concentration pathways (RCPs)</a></li>
<li><code>rcp45</code> (4.5 = current) and <code>rcp85</code> (8.5 = worse case)</li>
</ul></li>
<li>one elevation: slope</li>
<li>fuzzy model based on above description</li>
</ul>
</section>
<section id="pseudocode" class="level3">
<h3 class="anchored" data-anchor-id="pseudocode">Pseudocode</h3>
<p>The pseudocode below relies on routines I developed with guidance from course instructors and fellow students, organized with modules and their functions in the package <a href="https://github.com/byandell-envsys/landmapy">landmapy</a> as <a href="https://www.getdbt.com/blog/guide-to-dry">DRY</a> code. Workflows cited above have more detail on use and initial plots.</p>
<ol start="0" type="1">
<li>Create GeoDataFrame <code>buffalo_gdf</code> is created in step 0 and then stored for later retrieval.
<ul>
<li><code>grassland_gdf = gpd.read_file(grassland_url)</code></li>
<li><code>buffalo_gdf = grassland_gdf.loc[...]</code></li>
<li><code>plot_redline(buffalo_gdf)</code></li>
</ul></li>
<li>Soil and Climate Measures
<ol type="1">
<li>Soil measure is <code>mean</code> of <code>sand</code> at depth <code>100-200m</code> is created (ignoring <code>buffer</code> of <code>0.1</code>) with functions
<ul>
<li><code>buffalo_da = merge_soil(buffalo_gdf, "sand", "mean", "100_200")</code></li>
<li><code>gdf_over_da(buffalo_gdf, buffalo_da)</code></li>
</ul></li>
<li>Climate measures are projections of precipation <code>pr</code>
<ul>
<li><a href="https://sedac.ciesin.columbia.edu/ddc/ar5_scenario_process/RCPs.html">representative concentration pathway</a> scenarios <code>rcp45</code>, <code>rcp85</code></li>
<li><code>maca_df = process_maca({'buffalo': buffalo_gdf}, ['pr'], ['rcp85', 'rcp45'], [2026])</code></li>
<li><code>maca_2027_year_da = maca_year(maca_df, 0, 2027)</code> # 0 = <code>rcp85</code>, 1 = <code>rcp45</code></li>
<li><code>gdf_over_da(buffalo_gdf, maca_2027_year_da)</code></li>
</ul></li>
</ol></li>
<li>Digital Elevation measure <code>slope</code>
<ul>
<li><code>srtm_da = srtm_download(buffalo_gdf, elevation_dir, 0.1)</code></li>
<li><code>slope_da = srtm_slope(srtm_da)</code></li>
<li><code>gdf_over_da(buffalo_gdf, slope_da)</code></li>
</ul></li>
<li>Harmonize data
<ul>
<li><code>buffalo_sand_da = buffalo_da.rio.reproject_match(slope_da)</code></li>
<li><code>maca_2027_da = maca_2027_year_da.rio.reproject_match(slope_da)</code></li>
<li>similar reproject idea for soil and climate variables</li>
</ul></li>
<li>Build fuzzy model
<ul>
<li>use hill functions to transform harmonized DataArrays into 0-1 DataArrays</li>
<li>multiply them together</li>
<li><code>ramp_logic(maca_2027_da, (500, 550), (700, 750)).plot()</code></li>
<li><code>ramp_logic(buffalo_sand_da, (50, 60), (80, 90)).plot()</code></li>
<li><code>ramp_logic(slope_da, (0, 5), (15, 20)).plot()</code></li>
</ul></li>
</ol>
<p>Workflow details were developed in separate jupyter notebooks. Working documents that contribute to this workflow are as follows.</p>
<ul>
<li><a href="https://github.com/byandell-envsys/habitatSuitability/blob/main/0_study_area.ipynb">0_study_area</a></li>
<li><a href="https://github.com/byandell-envsys/habitatSuitability/blob/main/1_1_soil.ipynb">1_1_soil</a></li>
<li><a href="https://github.com/byandell-envsys/habitatSuitability/blob/main/1_2_climate.ipynb">1_2_climate</a></li>
<li><a href="https://github.com/byandell-envsys/habitatSuitability/blob/main/2_slope.ipynb">2_slope</a></li>
<li><a href="https://github.com/byandell-envsys/habitatSuitability/blob/main/3_harmonize.ipynb">3_harmonize</a></li>
<li><a href="https://github.com/byandell-envsys/habitatSuitability/blob/main/4_build.ipynb">4_build</a></li>
</ul>
</section>
<section id="create-buffalo-geodataframe" class="level2">
<h2 class="anchored" data-anchor-id="create-buffalo-geodataframe">Create Buffalo GeoDataFrame</h2>
<p>First visit <a href="https://data-usfs.hub.arcgis.com/datasets/usfs::national-grassland-units-feature-layer/explore">USFS Geospatial Data Discovery: National Grassland Units (Feature Layer)</a> and manually download GeoJSON file from DataSet into directory <code>~/earth-analytics/data/habitat</code> (see <code>create_data_dir()</code> below). A GeoDataFrame <code>buffalo_gdf</code> is created and stored for later retrieval to save time. The <code>plot_redline()</code> function is from <a href="https://github.com/byandell-envsys/landmapy/blob/main/landmapy/redline.py">landmapy.redline</a> module to visualize.</p>
<div id="b15f5c92" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd <span class="co"># read geojson file into gdf</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> landmapy.habitat <span class="im">import</span> create_data_dir <span class="co"># create (or retrieve) data directory</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> landmapy.redline <span class="im">import</span> plot_redline <span class="co"># plot gdf</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="875b9a73" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>store <span class="op">-</span>r buffalo_gdf</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    buffalo_gdf</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    data_dir <span class="op">=</span> create_data_dir(<span class="st">'habitat'</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read all grasslands GeoJSON into `grassland_gdf`.</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    grassland_url <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>data_dir<span class="sc">}</span><span class="ss">/National_Grassland_Units_(Feature_Layer).geojson"</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    grassland_gdf <span class="op">=</span> gpd.read_file(grassland_url)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Subset to desired locations.</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    buffalo_gdf <span class="op">=</span> grassland_gdf.loc[grassland_gdf[<span class="st">'GRASSLANDNAME'</span>].isin(</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"Buffalo Gap National Grassland"</span>, <span class="st">"Oglala National Grassland"</span>])]</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>store buffalo_gdf</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"buffalo_gdf created and stored"</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"buffalo_gdf retrieved from StoreMagic"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>buffalo_gdf retrieved from StoreMagic</code></pre>
</div>
</div>
<div id="38c06df6" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>plot_redline(buffalo_gdf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="buffalo_files/figure-html/cell-4-output-1.png" width="819" height="538" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="grassland-references" class="level3">
<h3 class="anchored" data-anchor-id="grassland-references">Grassland References</h3>
<ul>
<li><a href="https://www.fs.usda.gov/recarea/nebraska/recarea/?recid=30329">Buffalo Gap National Grassland</a>
<ul>
<li><a href="https://www.fs.usda.gov/detail/r2/recreation?cid=stelprdb5389082">Recreation Area</a></li>
<li><a href="https://naturalatlas.com/national-grasslands/buffalo-gap-2096999">Natural Atlas</a></li>
<li><a href="https://data-usfs.hub.arcgis.com/datasets/usfs::national-grassland-units-feature-layer/explore?location=43.534637%2C-102.565490%2C8.34">Data Download</a></li>
<li>(OBJECTID 186937, NATIONALGRASSLANDID 295518010328)<br>
</li>
</ul></li>
<li><a href="https://www.fs.usda.gov/recarea/nebraska/recarea/?recid=30328">Oglala National Grassland</a>
<ul>
<li><a href="https://visitnebraska.com/harrison/oglala-national-grassland">Visit</a></li>
<li><a href="https://data-usfs.hub.arcgis.com/datasets/usfs::national-grassland-units-feature-layer/explore?location=43.509639%2C-102.570535%2C8.36">Data Download</a></li>
<li>(OBJECTID 186940, NATIONALGRASSLANDID 295521010328)</li>
</ul></li>
</ul>
</section>
</section>
<section id="soil-and-climate-measures" class="level2">
<h2 class="anchored" data-anchor-id="soil-and-climate-measures">Soil and Climate Measures</h2>
<p>Download soil raster layer for <strong>sand</strong> covering study area envelope using the <a href="http://hydrology.cee.duke.edu/POLARIS/PROPERTIES/v1.0/">POLARIS dataset</a>. Considering <code>sand</code> percentage <code>mean</code>. POLARIS data are available at 6 depths, and Bluestem has roots down to 5 feet (150 cm), which is the lowest strata measured (100-200 cm). Data in the <a href="http://hydrology.cee.duke.edu/POLARIS/PROPERTIES/v1.0/sand/mean/100_200/">sand 100-200 cm directory</a> are saved as separate tif files by longitude. Buffalo Gap National Grassland is at (centroid) 43.4375° N, 103.0505° W, while Oglala National Grassland is at 42.9404° N, 103.5900° W. Below we use the <code>.total_bounds</code> extension on <code>buffalo_gdf</code> with the <code>merge_soil()</code> function in the <a href="https://github.com/byandell-envsys/landmapy/blob/main/landmapy/habitat.py">landmapy.habitat</a> module to automate finding bounds.</p>
<ul>
<li><a href="https://pubs.usgs.gov/publication/70170912">POLARIS: 30-meter probabilistic soil series map of contiguous US</a>
<ul>
<li><a href="https://scholars.duke.edu/publication/1381493" class="uri">https://scholars.duke.edu/publication/1381493</a></li>
<li><a href="https://gee-community-catalog.org/projects/polaris/" class="uri">https://gee-community-catalog.org/projects/polaris/</a></li>
<li>NW Chaney et al.&nbsp;(2019) POLARIS Soil Properties: 30-m Probabilistic Maps of Soil Properties Over the Contiguous United States. <a href="https://doi.org/10.1029/2018WR022797">DOI: 10.1029/2018WR022797</a></li>
</ul></li>
<li>Elsa Culler EarthLab Videos
<ul>
<li><a href="https://cuboulder.zoom.us/rec/share/imhCGJcrCgSoE1cJjg02r86GMNjiRz0jwVMJ5c0uWNwBCD5D_0kLSl3CaqLdDI2a.ucGta1EEAiirDUop">Accessing and formatting URLS for POLARIS data</a></li>
<li><a href="https://cuboulder.zoom.us/rec/share/3S7pGOSv7jztZTvg4RSXLj-GicnHwusIDIEDoETZbUN7ivkc6Ryi5GAJyX9Ly6h2.VXl6iFmLChjjUyOg">Looping through multiple tiles of POLARIS data</a></li>
</ul></li>
</ul>
<section id="sand-soil-measurement" class="level3">
<h3 class="anchored" data-anchor-id="sand-soil-measurement">Sand Soil Measurement</h3>
<p>Get and show <code>mean</code> of <code>sand</code> at depth <code>100-200m</code> with functions</p>
<ul>
<li><code>buffalo_da = merge_soil(buffalo_gdf, "sand", "mean", "100_200")</code></li>
<li><code>gdf_over_da(buffalo_gdf, buffalo_da)</code></li>
</ul>
<div id="5e757679" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> landmapy.habitat <span class="im">import</span> merge_soil <span class="co"># merge soil data from GDF</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> landmapy.index <span class="im">import</span> gdf_over_da <span class="co"># plot GDF over DA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Merge soil tiles to create <code>buffalo_da</code>.</p>
<div id="a2bf9fd2" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(buffalo_gdf.total_bounds)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>store <span class="op">-</span>r buffalo_da</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    buffalo_da</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    buffalo_da <span class="op">=</span> merge_soil(buffalo_gdf)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"buffalo_da merged soil from buffalo_gdf and stored"</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"buffalo_da soil merge retrieved"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[-104.05473027   42.74093601 -101.47233564   43.99459902]
buffalo_da soil merge retrieved</code></pre>
</div>
</div>
<div id="a3bc4e90" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>buffalo_gdf[<span class="st">'color'</span>] <span class="op">=</span> [<span class="st">'white'</span>,<span class="st">'red'</span>]</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>gdf_over_da(buffalo_gdf, buffalo_da, cmap<span class="op">=</span><span class="st">'viridis'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="buffalo_files/figure-html/cell-7-output-1.png" width="507" height="397" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="climate-precipitation-measure" class="level3">
<h3 class="anchored" data-anchor-id="climate-precipitation-measure">Climate Precipitation Measure</h3>
<p>Project precipation <code>pr</code> under representative concentration pathway scenarios <code>rcp45</code> and <code>rcp85</code> for years <code>2026-2030</code>.</p>
<div id="49718178" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> landmapy.habitat <span class="im">import</span> process_maca, maca_year</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> landmapy.index <span class="im">import</span> gdf_over_da</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="c69a7551" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>maca_df <span class="op">=</span> process_maca({<span class="st">'buffalo'</span>: buffalo_gdf})</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>maca_df[[<span class="st">'site_name'</span>, <span class="st">'scenario'</span>, <span class="st">'climate'</span>, <span class="st">'year'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">site_name</th>
<th data-quarto-table-cell-role="th">scenario</th>
<th data-quarto-table-cell-role="th">climate</th>
<th data-quarto-table-cell-role="th">year</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>buffalo</td>
<td>pr</td>
<td>rcp85</td>
<td>2026</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>buffalo</td>
<td>pr</td>
<td>rcp45</td>
<td>2026</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="ea365b5a" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>maca_2027_year_da <span class="op">=</span> maca_year(maca_df, <span class="dv">0</span>, <span class="dv">2027</span>) <span class="co"># 0 = `rcp85`, 1 = `rcp45`</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>gdf_over_da(buffalo_gdf, maca_2027_year_da)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="buffalo_files/figure-html/cell-10-output-1.png" width="549" height="397" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Repeat for <code>rcp45</code>. Make nice plot pair. Will need to modify <code>gdf_over_da()</code> to return object rather than create plot. This probably has some subtleties.</p>
</section>
</section>
<section id="slope-elevation-variable-slope" class="level2">
<h2 class="anchored" data-anchor-id="slope-elevation-variable-slope">Slope Elevation variable <code>slope</code></h2>
<ul>
<li><code>srtm_da = srtm_download(buffalo_gdf, elevation_dir, 0.1)</code></li>
<li><code>slope_da = srtm_slope(srtm_da)</code></li>
<li><code>gdf_over_da(buffalo_gdf, slope_da)</code></li>
</ul>
<div id="ea6b620d" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> earthaccess</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> landmapy.habitat <span class="im">import</span> create_data_dir, srtm_download, srtm_slope</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> landmapy.index <span class="im">import</span> gdf_over_da </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="ebd64922" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>project_dir <span class="op">=</span> create_data_dir(<span class="st">'habitat'</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>elevation_dir <span class="op">=</span> create_data_dir(<span class="st">'habitat/srtm'</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>elevation_dir</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>'/Users/brianyandell/earth-analytics/data/habitat/srtm'</code></pre>
</div>
</div>
<div id="6d60c9d8" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>earthaccess.login()</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>datasets <span class="op">=</span> earthaccess.search_datasets(keyword<span class="op">=</span><span class="st">'SRTM DEM'</span>, count<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> dataset <span class="kw">in</span> datasets:</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(dataset[<span class="st">'umm'</span>][<span class="st">'ShortName'</span>], dataset[<span class="st">'umm'</span>][<span class="st">'EntryTitle'</span>]) <span class="co"># want 'umn'</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co"># want SRTMGL1? 1 arc second = 30m (also, 3, 30 arc second)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>NASADEM_SHHP NASADEM SRTM-only Height and Height Precision Mosaic Global 1 arc second V001
NASADEM_SIM NASADEM SRTM Image Mosaic Global 1 arc second V001
NASADEM_SSP NASADEM SRTM Subswath Global 1 arc second V001
C_Pools_Fluxes_CONUS_1837 CMS: Terrestrial Carbon Stocks, Emissions, and Fluxes for Conterminous US, 2001-2016
SRTMGL1 NASA Shuttle Radar Topography Mission Global 1 arc second V003
GEDI01_B GEDI L1B Geolocated Waveform Data Global Footprint Level V002
NASADEM_HGT NASADEM Merged DEM Global 1 arc second V001
SRTMGL3 NASA Shuttle Radar Topography Mission Global 3 arc second V003
GEDI02_B GEDI L2B Canopy Cover and Vertical Profile Metrics Data Global Footprint Level V002
SRTMGL1_NC NASA Shuttle Radar Topography Mission Global 1 arc second NetCDF V003
SRTMGL30 NASA Shuttle Radar Topography Mission Global 30 arc second V002</code></pre>
</div>
</div>
<div id="a459a42b" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>srtm_da <span class="op">=</span> srtm_download(buffalo_gdf, elevation_dir, <span class="fl">0.1</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>gdf_over_da(buffalo_gdf, srtm_da, cmap<span class="op">=</span><span class="st">'terrain'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/users/brianyandell/miniconda3/envs/earth-analytics-python/lib/python3.11/site-packages/dask/dataframe/__init__.py:49: FutureWarning: 
Dask dataframe query planning is disabled because dask-expr is not installed.

You can install it with `pip install dask[dataframe]` or `conda install dask`.
This will raise in a future version.

  warnings.warn(msg, FutureWarning)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="buffalo_files/figure-html/cell-14-output-2.png" width="542" height="397" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="a2780106" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>slope_da <span class="op">=</span> srtm_slope(srtm_da)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>gdf_over_da(buffalo_gdf, slope_da, cmap<span class="op">=</span><span class="st">'terrain'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="buffalo_files/figure-html/cell-15-output-1.png" width="525" height="397" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Alternate plot only inside grasslands. Want to smooth over <code>buffalo_gdf</code> to fill in internal holes.</p>
<div id="45d2307d" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt <span class="co"># Overlay raster and vector data</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>slope_clip_da <span class="op">=</span> slope_da.rio.clip(buffalo_gdf.geometry)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>slope_clip_da.plot(cmap<span class="op">=</span><span class="st">'terrain'</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co">#buffalo_gdf.boundary.plot(ax=plt.gca(), color = "black", linewidth=0.5)</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="buffalo_files/figure-html/cell-16-output-1.png" width="582" height="449" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="harmonize-data" class="level2">
<h2 class="anchored" data-anchor-id="harmonize-data">Harmonize data</h2>
<p>See <a href="https://github.com/byandell-envsys/habitatSuitability/blob/main/3_harmonize.ipynb">3_harmonize</a>.</p>
<div id="f4db287b" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>buffalo_sand_da <span class="op">=</span> buffalo_da.rio.reproject_match(slope_da)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>maca_2027_da <span class="op">=</span> maca_2027_year_da.rio.reproject_match(slope_da)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="fuzzy-model" class="level2">
<h2 class="anchored" data-anchor-id="fuzzy-model">Fuzzy Model</h2>
<ul>
<li>use hill functions to transform harmonized DataArrays into 0-1 DataArrays</li>
<li>multiply them together</li>
</ul>
<p>See <a href="https://github.com/byandell-envsys/habitatSuitability/blob/main/4_build.ipynb">4_build</a></p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>